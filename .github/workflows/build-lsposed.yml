name: Build LSPosed Module

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    name: Build LSPosed Module
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout your repository
    - name: Checkout your code
      uses: actions/checkout@v3

    # Step 2: Clone the LSPosed repository
    - name: Clone LSPosed repository
      run: git clone --depth=1 https://github.com/LSPosed/LSPosed.git lsposed

    # Step 3: Clone libxposed/api
    - name: Clone libxposed API
      run: git clone --depth=1 https://github.com/libxposed/api.git libxposed/api

    # Step 4: Clone libxposed/service
    - name: Clone libxposed Service
      run: git clone --depth=1 https://github.com/libxposed/service.git libxposed/service

    # Step 5: Set up JDK 21
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'

    # Step 6: Build and publish libxposed API to Maven Local
    - name: Publish libxposed API to Maven Local
      run: |
        cd libxposed/api
        ./gradlew :api:publishApiPublicationToMavenLocal

    # Step 7: Build and publish libxposed Service to Maven Local
    - name: Publish libxposed Service to Maven Local
      run: |
        cd libxposed/service
        ./gradlew :interface:publishInterfacePublicationToMavenLocal

    # Step 8: Cache Gradle dependencies
    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: ~/.gradle/caches
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # Step 9: Locate and update build.gradle dynamically
    - name: Locate and update build.gradle for JVM target alignment
      run: |
        # Locate build.gradle file
        gradle_file=$(find lsposed -name "build.gradle" | head -n 1)
        if [ -z "$gradle_file" ]; then
          echo "No build.gradle file found in lsposed directory!"
          exit 1
        fi
        echo "Found build.gradle at $gradle_file"

        # Add JVM target for Kotlin
        if grep -q "kotlinOptions" "$gradle_file"; then
          sed -i '/kotlinOptions {/a \        jvmTarget = "21"' "$gradle_file"
          echo "Added jvmTarget to Kotlin options."
        else
          echo "No kotlinOptions block found in $gradle_file!"
          exit 1
        fi

        # Add Java toolchain configuration
        if grep -q "java {" "$gradle_file"; then
          sed -i '/java {/a \        toolchain {\n            languageVersion = JavaLanguageVersion.of(21)\n        }' "$gradle_file"
          echo "Added Java toolchain configuration."
        else
          echo "No java block found in $gradle_file!"
          exit 1
        fi

    # Step 10: Grant execute permission to Gradle wrapper
    - name: Make Gradle wrapper executable
      run: chmod +x lsposed/gradlew

    # Step 11: Build the LSPosed APK
    - name: Build LSPosed APK
      run: |
        cd lsposed
        ./gradlew assembleDebug

    # Step 12: Upload the APK as a build artifact
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: LSPosed-Module-APK
        path: lsposed/app/build/outputs/apk/debug/*.apk
